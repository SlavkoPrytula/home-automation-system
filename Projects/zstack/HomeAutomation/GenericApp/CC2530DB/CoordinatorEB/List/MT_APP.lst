###############################################################################
#
# IAR C/C++ Compiler V10.30.1.6000 for 8051               18/Apr/2021  17:01:53
# Copyright 2004-2018 IAR Systems AB.
# Evaluation license - IAR Embedded Workbench for 8051, Evaluation edition 10.30
#
#    Core               =  plain
#    Code model         =  banked
#    Data model         =  large
#    Calling convention =  xdata reentrant
#    Constant location  =  data_rom
#    Dptr setup         =  1,16
#                          
#    Source file        =  
#        C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Components\mt\MT_APP.c
#    Command line       =  
#        -f C:\users\slavko\Temp\EW3864.tmp ("C:\Texas Instruments\Z-Stack
#        3.0.2-20210417T211827Z-001\Z-Stack 3.0.2\Components\mt\MT_APP.c" -D
#        SECURE=1 -D TC_LINKKEY_JOIN -D NV_INIT -D NV_RESTORE -D xZTOOL_P1 -D
#        xMT_TASK -D xMT_APP_FUNC -D xMT_SYS_FUNC -D xMT_ZDO_FUNC -D
#        xMT_ZDO_MGMT -D xMT_APP_CNF_FUNC -D LEGACY_LCD_DEBUG -D
#        LCD_SUPPORTED=DEBUG -D MULTICAST_ENABLED=FALSE -D ZCL_READ -D
#        ZCL_WRITE -D ZCL_BASIC -D ZCL_IDENTIFY -D ZCL_SCENES -D ZCL_GROUPS -lC
#        "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\CoordinatorEB\List"
#        -lA "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\CoordinatorEB\List"
#        --diag_suppress Pe001,Pa010 -o "C:\Texas Instruments\Z-Stack
#        3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\CoordinatorEB\Obj"
#        -e --debug --core=plain --dptr=16,1 --data_model=large
#        --code_model=banked --calling_convention=xdata_reentrant
#        --place_constants=data_rom --nr_virtual_regs 16 -f "C:\Texas
#        Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wCoord.cfg"
#        (-DCPU32MHZ -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRUE
#        -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8 -DMAC_CFG_RX_MAX=5
#        -DZDO_COORDINATOR -DRTR_NWK) -f "C:\Texas Instruments\Z-Stack
#        3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg"
#        (-DZIGBEEPRO -DSECURE=1 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR
#        -DDEFAULT_CHANLIST=0x00000800 -DZDAPP_CONFIG_PAN_ID=0xFFFF
#        -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MASK=0x007F
#        -DBEACON_REQUEST_DELAY=100 -DBEACON_REQ_DELAY_MASK=0x00FF
#        -DLINK_STATUS_JITTER_MASK=0x007F -DROUTE_EXPIRY_TIME=30
#        -DAPSC_ACK_WAIT_DURATION_POLLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7
#        -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3
#        -DNWK_MAX_DATA_RETRIES=2 -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9
#        -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40 -DNWK_MAX_BINDING_ENTRIES=4
#        -DMAX_BINDING_CLUSTER_IDS=4 -DDEFAULT_KEY={0} -DMAC_MAX_FRAME_SIZE=116
#        -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const __code"
#        -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000
#        -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100 -DREJOIN_POLL_RATE=440
#        -DREJOIN_BACKOFF=900000 -DREJOIN_SCAN=900000 -DENABLE_LED4_DISABLE_S1)
#        -f "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wZCL.cfg"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\" -I
#        "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\Source\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\Source\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\ZMain\TI2530DB\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\hal\include\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\hal\target\CC2530EB\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\mac\include\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\mac\high_level\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\single_chip\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\mt\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\osal\include\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\services\saddr\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\services\sdata\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\af\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\bdb\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\gp\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\nwk\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\sapi\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\sec\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\sys\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\zcl\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\stack\zdo\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\zmac\"
#        -I "C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\..\..\..\..\..\Components\zmac\f8w\"
#        -Ohz --require_prototypes)
#    Locale             =  English_USA.1252
#    List file          =  
#        C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\CoordinatorEB\List\MT_APP.lst
#    Object file        =  
#        C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\GenericApp\CC2530DB\CoordinatorEB\Obj\MT_APP.r51
#
###############################################################################

C:\Texas Instruments\Z-Stack 3.0.2-20210417T211827Z-001\Z-Stack 3.0.2\Components\mt\MT_APP.c
      1          /***************************************************************************************************
      2            Filename:       MT_APP.c
      3            Revised:        $Date: 2015-01-26 08:25:50 -0800 (Mon, 26 Jan 2015) $
      4            Revision:       $Revision: 42025 $
      5          
      6            Description:    MonitorTest processing for APP commands
      7          
      8            Copyright 2007-2015 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License"). You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product. Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT.h"        /* This is here because all the SPI_CMD_XXX are defined in this header */
     45          #include "MT_APP.h"
     46          #include "MT_AF.h"     /* This is here because this MT_APP makes some routine call to AF */
     47          #include "MT_RPC.h"
     48          
     49          #if defined( APP_TP )
     50           #include "TestProfile.h"
     51          #endif
     52          #if defined( APP_TP2 )
     53           #include "TestProfile2.h"
     54           #include "nwk_util.h"
     55          #endif
     56          
     57          /***************************************************************************************************
     58           * LOCAL FUNCTIONS
     59           ***************************************************************************************************/
     60          #if defined (MT_APP_FUNC)
     61          static void MT_AppMsg(uint8 *pBuf);
     62          static void MT_AppUserCmd(byte *pData);
     63          #if defined ( MT_APP_PB_ZCL_FUNC )
     64          static void MT_AppPB_ZCLMsg(byte *pData);
     65          static void MT_AppPB_ZCLCfg(byte *pData);
     66          #endif // MT_APP_PB_ZCL_FUNC
     67          #endif // MT_APP_FUNC
     68          
     69          #if defined (MT_APP_FUNC)
     70          /***************************************************************************************************
     71           * @fn      MT_AppCommandProcessing
     72           *
     73           * @brief  Process all the APP commands that are issued by test tool
     74           *
     75           * @param   pBuf - pointer to the received buffer
     76           *
     77           * @return  status
     78           ***************************************************************************************************/
     79          uint8 MT_AppCommandProcessing(uint8 *pBuf)
     80          {
     81            uint8 status = MT_RPC_SUCCESS;
     82          
     83            switch (pBuf[MT_RPC_POS_CMD1])
     84            {
     85              case MT_APP_MSG:
     86                MT_AppMsg(pBuf);
     87                break;
     88          
     89              case MT_APP_USER_TEST:
     90                MT_AppUserCmd(pBuf);
     91                break;
     92          
     93          #if defined ( MT_APP_PB_ZCL_FUNC )
     94              case MT_APP_PB_ZCL_MSG:
     95                MT_AppPB_ZCLMsg(pBuf);
     96                break;
     97          
     98              case MT_APP_PB_ZCL_CFG:
     99                MT_AppPB_ZCLCfg(pBuf);
    100                break;
    101          #endif // MT_APP_PB_ZCL_FUNC
    102          
    103              default:
    104                status = MT_RPC_ERR_COMMAND_ID;
    105                break;
    106            }
    107          
    108            return status;
    109          }
    110          
    111          /***************************************************************************************************
    112           * @fn      MT_AppMsg
    113           *
    114           * @brief   Process APP_MSG command
    115           *
    116           * @param   pBuf - pointer to the received buffer
    117           *
    118           * @return  void
    119           ***************************************************************************************************/
    120          static void MT_AppMsg(uint8 *pBuf)
    121          {
    122            uint8 retValue = ZFailure;
    123            uint8 endpoint;
    124            endPointDesc_t *epDesc;
    125            mtSysAppMsg_t *msg;
    126            uint8 cmdId, dataLen;
    127          
    128            /* parse header */
    129            dataLen = pBuf[MT_RPC_POS_LEN];
    130            cmdId = pBuf[MT_RPC_POS_CMD1];
    131            pBuf += MT_RPC_FRAME_HDR_SZ;
    132          
    133            /* Get the endpoint and skip past it.*/
    134            endpoint = *pBuf++;
    135            dataLen--;
    136          
    137            /* Look up the endpoint */
    138            epDesc = afFindEndPointDesc( endpoint );
    139          
    140            if (epDesc)
    141            {
    142              /* Build and send the message to the APP */
    143              msg = (mtSysAppMsg_t *)osal_msg_allocate(sizeof(mtSysAppMsg_t) + (dataLen));
    144              if ( msg )
    145              {
    146                /* Build and send message up the app */
    147                msg->hdr.event = MT_SYS_APP_MSG;
    148                msg->endpoint = endpoint;
    149                msg->appDataLen = dataLen;
    150                msg->appData = (uint8*)(msg+1);
    151                osal_memcpy( msg->appData, pBuf, dataLen);
    152                osal_msg_send( *(epDesc->task_id), (uint8 *)msg );
    153          
    154                /* Info for response */
    155                retValue = ZSuccess;
    156              }
    157            }
    158          
    159            /* Build and send back the response */
    160            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_APP), cmdId, 1, &retValue);
    161          }
    162          
    163          /***************************************************************************************************
    164           * @fn      MT_AppMsg
    165           *
    166           * @brief   Process APP_MSG command
    167           *
    168           * @param   pBuf - pointer to the received buffer
    169           *
    170           * @return  void
    171           ***************************************************************************************************/
    172          static void MT_AppUserCmd(uint8 *pBuf)
    173          {
    174          
    175            uint8 retValue, cmdId;
    176          
    177          #if defined (APP_TGEN) || defined (NWK_TEST) || defined (APP_TP) || defined (APP_TP2) || defined (OSAL_TOTAL_MEM) || defined (APP_DEBUG)
    178            uint16 app_cmd;
    179            uint8 srcEp;
    180            uint16 param1;
    181            uint16 param2;
    182          #endif
    183          #if defined (OSAL_TOTAL_MEM)
    184            uint8 pData[2];
    185          #endif
    186          
    187            /* parse header */
    188            cmdId = pBuf[MT_RPC_POS_CMD1];
    189            pBuf += MT_RPC_FRAME_HDR_SZ;
    190          
    191            retValue = INVALID_TASK;     //should be changed later
    192          
    193          #if defined (APP_TGEN) || defined (NWK_TEST) || defined (APP_TP) || defined (APP_TP2) || defined (OSAL_TOTAL_MEM) || defined (APP_DEBUG)
    194          
    195            srcEp = *pBuf++;
    196          
    197            app_cmd = osal_build_uint16( pBuf );
    198            pBuf = pBuf + sizeof( uint16 );
    199          
    200            param1 = osal_build_uint16( pBuf );
    201            pBuf = pBuf + sizeof( uint16 );
    202          
    203            param2 = osal_build_uint16( pBuf );
    204          
    205            switch ( app_cmd )
    206            {
    207          
    208          #if defined (APP_TGEN)
    209              case TGEN_START:
    210                TrafficGenApp_SendCmdMSG( param1, param2, TRAFFICGENAPP_CMD_START );
    211                retValue = ZSUCCESS;
    212                break;
    213          
    214              case TGEN_STOP:
    215                TrafficGenApp_SendCmdMSG( param1, param2, TRAFFICGENAPP_CMD_STOP );
    216                retValue = ZSUCCESS;
    217                break;
    218          
    219              case TGEN_COUNT:
    220                retValue = TrafficGenApp_CountPkt( param1, param2 );
    221                return;
    222                break;
    223          #endif
    224          
    225          #if defined (NWK_TEST)
    226              case HW_TEST:
    227                HwApp_Start( HI_UINT16(param1), LO_UINT16(param1), HI_UINT16(param2),
    228                              1000, LO_UINT16(param2), 3, 0 );
    229                break;
    230          
    231              case HW_DISPLAY_RESULT:
    232                HwApp_TestInfo();
    233                break;
    234          
    235              case HW_SEND_STATUS:
    236                HwApp_SendStats();
    237                break;
    238          #endif
    239          
    240          #if defined( APP_TP ) || defined ( APP_TP2 )
    241            #if defined( APP_TP )
    242              case TP_SEND_NODATA:
    243                retValue = TestProfileApp_SendNoData( srcEp, (byte)param1 );
    244                break;
    245            #endif // APP_TP
    246          
    247              case TP_SEND_BUFFERTEST:
    248                retValue = TestProfileApp_SendBufferReq( srcEp, (uint8)param1, (uint8)param2 );
    249                break;
    250          
    251            #if defined( APP_TP )
    252              case TP_SEND_UINT8:
    253                retValue = TestProfileApp_SendUint8( srcEp, (byte)param1 );
    254                break;
    255          
    256              case TP_SEND_INT8:
    257                retValue = TestProfileApp_SendInt8( srcEp, (byte)param1 );
    258                break;
    259          
    260              case TP_SEND_UINT16:
    261                retValue = TestProfileApp_SendUint16( srcEp, (byte)param1 );
    262                break;
    263          
    264              case TP_SEND_INT16:
    265                retValue = TestProfileApp_SendInt16( srcEp, (byte)param1 );
    266                break;
    267          
    268              case TP_SEND_SEMIPREC:
    269                retValue = TestProfileApp_SendSemiPrec( srcEp, (byte)param1 );
    270                break;
    271          
    272              case TP_SEND_FREEFORM:
    273                retValue = TestProfileApp_SendFreeFormReq( srcEp, (byte)param1 );
    274                break;
    275          
    276            #else // APP_TP
    277              case TP_SEND_FREEFORM:
    278                retValue = TestProfileApp_SendFreeFormReq(srcEp, (byte)param1, (byte)param2);
    279                break;
    280            #endif
    281          
    282            #if defined( APP_TP )
    283              case TP_SEND_ABS_TIME:
    284                retValue = TestProfileApp_SendAbsTime( srcEp, (byte)param1 );
    285                break;
    286          
    287              case TP_SEND_REL_TIME:
    288                retValue = TestProfileApp_SendRelativeTime( srcEp, (byte)param1 );
    289                break;
    290          
    291              case TP_SEND_CHAR_STRING:
    292                retValue = TestProfileApp_SendCharString( srcEp, (byte)param1 );
    293                break;
    294          
    295              case TP_SEND_OCTET_STRING:
    296                retValue = TestProfileApp_SendOctetString( srcEp, (byte)param1 );
    297                break;
    298            #endif // APP_TP
    299          
    300              case TP_SET_DSTADDRESS:
    301                retValue = TestProfileApp_SetDestAddress(HI_UINT16(param1), LO_UINT16(param1), param2);
    302                break;
    303          
    304            #if defined( APP_TP2 )
    305              case TP_SEND_BUFFER_GROUP:
    306                retValue = TestProfileApp_SendBufferGroup( srcEp, (byte)param1 );
    307                break;
    308            #endif // APP_TP
    309          
    310              case TP_SEND_BUFFER:
    311                retValue = TestProfileApp_SendBuffer( srcEp, (byte)param1 );
    312                break;
    313          
    314            #if defined( APP_TP )
    315              case TP_SEND_MULT_KVP_8BIT:
    316                TestProfileApp_SendMultiKVP_8bit( srcEp, (byte)param1 );
    317                retValue = ZSuccess;
    318                break;
    319          
    320              case TP_SEND_MULT_KVP_16BIT:
    321                TestProfileApp_SendMultiKVP_16bit( srcEp, (byte)param1 );
    322                retValue = ZSuccess;
    323                break;
    324          
    325              case TP_SEND_MULT_KVP_TIME:
    326                TestProfileApp_SendMultiKVP_Time( srcEp, (byte)param1 );
    327                retValue = ZSuccess;
    328                break;
    329          
    330              case TP_SEND_MULT_KVP_STRING:
    331                TestProfileApp_SendMultiKVP_String( srcEp, (byte)param1 );
    332                retValue = ZSuccess;
    333                break;
    334          
    335              case TP_SEND_MULTI_KVP_STR_TIME:
    336                retValue = ZSuccess;
    337                TestProfileApp_SendMultiKVP_String_Time( srcEp, (byte)param1 );
    338                break;
    339            #endif // APP_TP
    340          
    341              case TP_SEND_COUNTED_PKTS:
    342                TestProfileApp_SendCountedPktsReq(HI_UINT16(param1), LO_UINT16(param1), param2);
    343                retValue = ZSuccess;
    344                break;
    345          
    346              case TP_SEND_RESET_COUNTER:
    347                TestProfileApp_CountedPakts_ResetCounterReq( (byte)param1 );
    348                retValue = ZSuccess;
    349                break;
    350          
    351              case TP_SEND_GET_COUNTER:
    352                TestProfileApp_CountedPakts_GetCounterReq( srcEp, (byte)param1 );
    353                retValue = ZSuccess;
    354                break;
    355          
    356              case TP_SET_PERMIT_JOIN:
    357                if ( ZG_BUILD_RTR_TYPE && ZG_DEVICE_RTR_TYPE )
    358                {
    359                  NLME_PermitJoiningRequest( (byte)param1 );
    360                  retValue = ZSuccess;
    361                }
    362                else
    363                {
    364                  retValue = ZFailure;
    365                }
    366                break;
    367          
    368            #if defined ( APP_TP2 )
    369              case TP_ADD_GROUP:
    370                retValue = TestProfileApp_SetGroup( srcEp, param1 );
    371                break;
    372          
    373              case TP_REMOVE_GROUP:
    374                retValue = TestProfileApp_RemoveGroup( srcEp, param1 );
    375                break;
    376          
    377              case TP_SEND_UPDATE_KEY:
    378                retValue = TestProfileApp_UpdateKey( srcEp, (uint8)param1, param2 );
    379                break;
    380          
    381              case TP_SEND_SWITCH_KEY:
    382                retValue = TestProfileApp_SwitchKey(  srcEp, (uint8)param1, param2 );
    383                break;
    384          
    385              case TP_SEND_BUFFERTEST_GROUP:
    386                retValue = TestProfileApp_SendBufferGroupReq( srcEp, (byte)param1, (byte)param2 );
    387                break;
    388          
    389              case TP_SEND_ROUTE_DISC_REQ:
    390                retValue = TestProfileApp_SendRouteDiscReq( srcEp, param1,
    391                                            HI_UINT16( param2 ), LO_UINT16( param2 ) );
    392                break;
    393          
    394              case TP_SEND_ROUTE_DISCOVERY:
    395                if ( ZG_BUILD_RTR_TYPE && ZG_DEVICE_RTR_TYPE )
    396                {
    397                  retValue = TestProfileApp_SendRouteDiscovery( param1,
    398                                              HI_UINT16( param2 ), LO_UINT16( param2 ) );
    399                }
    400                break;
    401          
    402              case TP_SEND_NEW_ADDR:
    403                retValue = TestProfileApp_ChangeShortAddr( param1, LO_UINT16(param2) );
    404                break;
    405          
    406              case TP_SEND_NWK_UPDATE:
    407                /* Send out a Network Update command. */
    408                retValue = NLME_SendNetworkUpdate( NWK_BROADCAST_SHORTADDR, NWKUPDATE_PANID_UPDATE,
    409                                                  _NIB.extendedPANID, _NIB.nwkUpdateId+1, param1 );
    410                break;
    411          
    412              case TP_NWK_ADDR_CONFLICT:
    413                retValue = NLME_SendNetworkStatus( NWK_BROADCAST_SHORTADDR_DEVZCZR, param1,
    414                                                   NWKSTAT_ADDRESS_CONFLICT, FALSE );
    415                break;
    416          
    417           #if (ZG_BUILD_JOINING_TYPE)
    418              case TP_AK_SETUP_PARTNER:
    419                retValue = TestProfileApp_AppKeySetupPartner( srcEp, param1, param2 );
    420                break;
    421          
    422              case TP_AK_REQ_KEY:
    423                retValue = TestProfileApp_AppKeyRequest( srcEp, param1, param2 );
    424                break;
    425          
    426              case TP_AK_PARTNER_NWKADDR:
    427                retValue = TestProfileApp_SetPartnerNwkAddr( srcEp, param1, param2 );
    428                break;
    429          
    430              case TP_AK_PARTNER_EXTADDR7654:
    431                 retValue = TestProfileApp_SetPartnerExtAddr7654( srcEp, param1, param2 );
    432                break;
    433          
    434              case TP_AK_PARTNER_EXTADDR3210:
    435                retValue = TestProfileApp_SetPartnerExtAddr3210( srcEp, param1, param2 );
    436                break;
    437          
    438              case TP_AK_PARTNER_SET:
    439                retValue = TestProfileApp_SetPartner( srcEp, param1, param2 );
    440                break;
    441          #endif /* ZG_BUILD_JOINING_TYPE */
    442          
    443          #if (ZG_BUILD_COORDINATOR_TYPE)
    444              case TP_AK_TYPE_SET:
    445                retValue = TestProfileApp_AppKeyTypeSet( srcEp, param1, param2 );
    446                break;
    447          #endif /* ZG_BUILD_COORDINATOR_TYPE */
    448          
    449          #if defined ( ZIGBEE_FRAGMENTATION )
    450              case TP_FRAG_SKIP_BLOCK:
    451                retValue = TestProfileApp_FragSkipBlock( (uint8)param1 );
    452                break;
    453          #endif
    454          
    455              case TP_APS_REMOVE:
    456                retValue = TestProfileApp_APSRemove( param1, param2 );
    457                break;
    458          
    459          #if defined ( APP_TP2_TEST_MODE )
    460              case TP_GU_SET_TX_APS_SEC:
    461                retValue = TestProfileApp_GuSetTxApsSecurity( LO_UINT16(param1), param2 );
    462                break;
    463          
    464              case TP_GU_SET_RX_APS_SEC:
    465                retValue = TestProfileApp_GuSetRxApsSecurity( LO_UINT16(param1), param2 );
    466                break;
    467          #endif
    468          
    469              case TP_SET_LEAVE_REQ_ALLOWED:
    470                retValue = TestProfileApp_SetLeaveReqAllowed( LO_UINT16(param1) );
    471                break;
    472                
    473              case TP_SET_NOT_REMOVE_DEV_WHEN_SEND_LEAVE_REQ:
    474                retValue = TestProfileApp_SetNotRemoveWhenSendLeaveReq(LO_UINT16(param1));
    475                  break;
    476          
    477            case TP_SEND_REJOIN_REQ_SECURE:
    478                retValue = TestProfileApp_SendRejoinReqSecurity( param1, param2 , TRUE);
    479                break;
    480                
    481            case TP_SEND_REJOIN_REQ_UNSECURE:
    482                retValue = TestProfileApp_SendRejoinReqSecurity( param1, param2, FALSE );
    483              break;
    484          #endif // APP_TP2
    485          
    486          #endif  // APP_TP || APP_TP2
    487          
    488          #if defined ( OSAL_TOTAL_MEM )
    489              case OSAL_MEM_STACK_HIGH_WATER:
    490              case OSAL_MEM_HEAP_HIGH_WATER:
    491                if ( app_cmd == OSAL_MEM_STACK_HIGH_WATER)
    492                {
    493                  param1 = osal_stack_used();
    494                }
    495                else
    496                {
    497                  param1 = osal_heap_high_water();
    498                }
    499          
    500                pData[0] = LO_UINT16( param1 );
    501                pData[1] = HI_UINT16( param1 );
    502          
    503                MT_BuildAndSendZToolResponse((MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_APP), cmdId, 2, pData);
    504                return;
    505          #endif
    506          
    507          #if defined ( APP_DEBUG )
    508              case DEBUG_GET:
    509                DebugApp_SendQuery( param1 );
    510                retValue = ZSUCCESS;
    511                break;
    512          #endif
    513          
    514          #if defined ( APP_TP2 )
    515              case TP_SEND_BCAST_RSP:
    516                retValue = TestProfileApp_SendBcastRsp( srcEp, (byte)param1 );
    517                break;
    518          #endif
    519          
    520              default:
    521                break;
    522            }
    523          #endif // (APP_TGEN) || (NWK_TEST) || (APP_TP) || (APP_TP2) || (OSAL_TOTAL_MEM) || (APP_DEBUG)
    524          
    525            /* Build and send back the response */
    526            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_APP), cmdId, 1, &retValue);
    527          }
    528          
    529          #if defined ( MT_APP_PB_ZCL_FUNC )
    530          /***************************************************************************************************
    531           * @fn      MT_AppPB_ZCLMsg
    532           *
    533           * @brief   Process MT_APP_PB_ZCL_MSG command
    534           *
    535           * @param   pBuf - pointer to the received buffer
    536           *
    537           * @return  void
    538           ***************************************************************************************************/
    539          static void MT_AppPB_ZCLMsg( uint8 *pBuf )
    540          {
    541            uint8 retValue = ZFailure;
    542            uint8 appEP;
    543            endPointDesc_t *epDesc;
    544            mtAppPB_ZCLMsg_t *cmd;
    545            uint8 cmdId;
    546            uint8 dataLen;
    547          
    548            /* Parse the RPC header */
    549            dataLen = pBuf[MT_RPC_POS_LEN] - MT_APP_PB_ZCL_MSG_HDR_LEN;
    550            cmdId = pBuf[MT_RPC_POS_CMD1];
    551            pBuf += MT_RPC_FRAME_HDR_SZ;
    552          
    553            /* Application End Point */
    554            appEP = *pBuf++;
    555          
    556            /* Look up the endpoint */
    557            epDesc = afFindEndPointDesc( appEP );
    558          
    559            if ( epDesc )
    560            {
    561              /* Build and send the message to the APP */
    562              cmd = (mtAppPB_ZCLMsg_t *)osal_msg_allocate( sizeof( mtAppPB_ZCLMsg_t ) + dataLen );
    563              if ( cmd )
    564              {
    565                /* Build and send message to the app */
    566                cmd->hdr.event = MT_SYS_APP_PB_ZCL_CMD;
    567          
    568                /* PB ZCL command type */
    569                cmd->type = MT_APP_PB_ZCL_CMD_MSG;
    570          
    571                /* Application End Point */
    572                cmd->appEP = appEP;
    573          
    574                /* Destination Address */
    575                cmd->dstAddr.addr.shortAddr = osal_build_uint16( pBuf );
    576                pBuf += sizeof(uint16);
    577          
    578                /* Destination Address Mode */
    579                cmd->dstAddr.addrMode = afAddr16Bit;
    580          
    581                /* Destination End Point */
    582                cmd->dstAddr.endPoint = *pBuf++;;
    583          
    584                /* Use Default PAN ID */
    585                cmd->dstAddr.panId = 0xFFFF;
    586          
    587                /* Cluster ID */
    588                cmd->clusterID = osal_build_uint16( pBuf );
    589                pBuf += sizeof( uint16 );
    590          
    591                /* Command ID */
    592                cmd->commandID = *pBuf++;
    593          
    594                /* Cluster Specific Command */
    595                cmd->specific = *pBuf++;
    596          
    597                /* Command Direction */
    598                cmd->direction = *pBuf++;
    599          
    600                /* Disable Default Response */
    601                cmd->disableDefRsp = *pBuf++;
    602          
    603                /* Manufacturer Code */
    604                cmd->manuCode = osal_build_uint16( pBuf );
    605                pBuf += sizeof( uint16 );
    606          
    607                /* ZCL Transaction Sequence Number */
    608                cmd->transSeqNum  = *pBuf++;
    609          
    610                /* Application Data Length */
    611                cmd->appPBDataLen = dataLen;
    612          
    613                /* Application Data */
    614                cmd->appPBData = (uint8 *)( cmd + 1 );
    615                osal_memcpy( cmd->appPBData, pBuf, dataLen );
    616          
    617                /* Send the message */
    618                osal_msg_send( *(epDesc->task_id), (uint8 *)cmd );
    619          
    620                /* Info for response */
    621                retValue = ZSuccess;
    622              }
    623            }
    624          
    625            /* Build and send back the response */
    626            MT_BuildAndSendZToolResponse( ( (uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_APP ),
    627                                          cmdId, 1, &retValue);
    628          }
    629          #endif
    630          
    631          #if defined ( MT_APP_PB_ZCL_FUNC )
    632          /***************************************************************************************************
    633           * @fn      MT_AppPB_ZCLCfg
    634           *
    635           * @brief   Process MT_APP_PB_ZCL_CFG command
    636           *
    637           * @param   pBuf - pointer to the received buffer
    638           *
    639           * @return  void
    640           ***************************************************************************************************/
    641          static void MT_AppPB_ZCLCfg( uint8 *pBuf )
    642          {
    643            uint8 retValue = ZFailure;
    644            uint8 appEP;
    645            endPointDesc_t *epDesc;
    646            mtAppPB_ZCLCfg_t *cmd;
    647            uint8 cmdId;
    648          
    649            /* Parse the RPC header */
    650            cmdId = pBuf[MT_RPC_POS_CMD1];
    651            pBuf += MT_RPC_FRAME_HDR_SZ;
    652          
    653            /* Application End Point */
    654            appEP = *pBuf++;
    655          
    656            /* Look up the endpoint */
    657            epDesc = afFindEndPointDesc( appEP );
    658          
    659            if ( epDesc )
    660            {
    661              /* Build and send the message to the APP */
    662              cmd = (mtAppPB_ZCLCfg_t *)osal_msg_allocate( sizeof( mtAppPB_ZCLCfg_t ) );
    663          
    664              if ( cmd )
    665              {
    666                /* Build and send message to the app */
    667                cmd->hdr.event = MT_SYS_APP_PB_ZCL_CMD;
    668          
    669                /* PB ZCL command type*/
    670                cmd->type = MT_APP_PB_ZCL_CMD_CFG;
    671          
    672                /* PB ZCL Config Mode */
    673                cmd->mode = *pBuf++;
    674          
    675                /* Send the message */
    676                osal_msg_send( *(epDesc->task_id), (uint8 *)cmd );
    677          
    678                /* Info for response */
    679                retValue = ZSuccess;
    680              }
    681            }
    682          
    683            /* Build and send back the response */
    684            MT_BuildAndSendZToolResponse( ( (uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_APP ),
    685                                          cmdId, 1, &retValue );
    686          }
    687          #endif
    688          
    689          /***************************************************************************************************
    690           * @fn      MT_AppPB_ZCLInd
    691           *
    692           * @brief   Send an MT_APP_PB_ZCL_IND command
    693           *
    694           * @param   pInd - pointer to the indication
    695           *
    696           * @return  void
    697           ***************************************************************************************************/
    698          void MT_AppPB_ZCLInd( mtAppPB_ZCLInd_t *pInd )
    699          {
    700            uint8 *pData;
    701            uint8 *pBuf;
    702            uint8 len;
    703          
    704            len = MT_APP_PB_ZCL_IND_HDR_LEN + pInd->appPBDataLen;
    705          
    706            pData = (uint8 *)osal_mem_alloc( len );
    707            if ( pData != NULL )
    708            {
    709              pBuf = pData;
    710              *pBuf++ = pInd->appEP;
    711              *pBuf++ = LO_UINT16( pInd->srcAddr );
    712              *pBuf++ = HI_UINT16( pInd->srcAddr );
    713              *pBuf++ = pInd->srcEP;
    714              *pBuf++ = LO_UINT16( pInd->clusterID );
    715              *pBuf++ = HI_UINT16( pInd->clusterID );
    716              *pBuf++ = pInd->commandID;
    717              *pBuf++ = pInd->specific;
    718              *pBuf++ = pInd->direction;
    719              *pBuf++ = pInd->disableDefRsp;
    720              *pBuf++ = LO_UINT16( pInd->manuCode );
    721              *pBuf++ = HI_UINT16( pInd->manuCode );
    722              *pBuf++ = pInd->transSeqNum;
    723              osal_memcpy( pBuf, pInd->appPBData, pInd->appPBDataLen );
    724          
    725              MT_BuildAndSendZToolResponse( ( (uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_APP ),
    726                                            MT_APP_PB_ZCL_IND, len, pData );
    727              osal_mem_free( pData );
    728            }
    729          }
    730          
    731          #endif /* MT_APP_FUNC */
    732          
    733          /***************************************************************************************************
    734           ***************************************************************************************************/


 

 


Errors: none
Warnings: none
